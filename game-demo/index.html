<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HTML5æ¸¸æˆæ¼”ç¤º</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #2c3e50;
      color: white;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    
    .game-header {
      background-color: #34495e;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .game-title {
      font-size: 18px;
      font-weight: bold;
    }
    
    .user-info {
      font-size: 14px;
      display: flex;
      align-items: center;
    }
    
    .user-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: #3498db;
      margin-right: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .game-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    
    .game-canvas {
      width: 500px;
      height: 300px;
      max-width: 100%;
      background-color: #1a2733;
      border-radius: 8px;
      position: relative;
      overflow: hidden;
    }
    
    .game-player {
      width: 40px;
      height: 40px;
      background-color: #3498db;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      transition: all 0.1s ease;
    }
    
    .game-target {
      width: 30px;
      height: 30px;
      background-color: #e74c3c;
      border-radius: 5px;
      position: absolute;
      transform: translate(-50%, -50%);
    }
    
    .game-score {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: rgba(0, 0, 0, 0.5);
      padding: 5px 10px;
      border-radius: 20px;
    }
    
    .game-controls {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    
    .achievement-popup {
      position: absolute;
      top: 50px;
      right: 20px;
      background-color: #27ae60;
      padding: 10px 15px;
      border-radius: 5px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
      transform: translateX(120%);
      transition: transform 0.3s ease;
      display: flex;
      align-items: center;
      max-width: 250px;
    }
    
    .achievement-popup.show {
      transform: translateX(0);
    }
    
    .achievement-icon {
      margin-right: 10px;
      font-size: 24px;
    }
    
    button {
      background-color: #3498db;
      border: none;
      color: white;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    button:hover {
      background-color: #2980b9;
    }
    
    button:active {
      transform: translateY(1px);
    }
  </style>
</head>
<body>
  <div class="game-header">
    <div class="game-title">ç®€æ˜“æ”¶é›†æ¸¸æˆ</div>
    <div class="user-info">
      <div class="user-avatar">?</div>
      <span class="user-name">æ¸¸å®¢</span>
    </div>
  </div>
  
  <div class="game-container">
    <div class="game-canvas">
      <div class="game-player"></div>
      <div class="game-score">å¾—åˆ†: <span id="score">0</span></div>
    </div>
    
    <div class="achievement-popup" id="achievement">
      <div class="achievement-icon">ğŸ†</div>
      <div>
        <div class="achievement-title">è·å¾—æˆå°±!</div>
        <div class="achievement-desc">æˆå°±æè¿°</div>
      </div>
    </div>
    
    <div class="game-controls">
      <button id="start-btn">å¼€å§‹æ¸¸æˆ</button>
      <button id="send-progress-btn">ä¿å­˜è¿›åº¦</button>
      <button id="unlock-achievement-btn">è§£é”æˆå°±</button>
    </div>
  </div>
  
  <script>
    // æ¸¸æˆçŠ¶æ€
    const gameState = {
      playerX: 50,
      playerY: 50,
      score: 0,
      targetX: 0,
      targetY: 0,
      isPlaying: false,
      userInfo: null
    };
    
    // æ¸¸æˆå…ƒç´ 
    const gameElements = {
      player: document.querySelector('.game-player'),
      canvas: document.querySelector('.game-canvas'),
      scoreDisplay: document.getElementById('score'),
      startButton: document.getElementById('start-btn'),
      saveProgressButton: document.getElementById('send-progress-btn'),
      achievementButton: document.getElementById('unlock-achievement-btn'),
      achievementPopup: document.getElementById('achievement'),
      userAvatar: document.querySelector('.user-avatar'),
      userName: document.querySelector('.user-name')
    };
    
    // ç”Ÿæˆéšæœºä½ç½®
    function generateRandomPosition() {
      const canvasRect = gameElements.canvas.getBoundingClientRect();
      const maxX = canvasRect.width - 30;
      const maxY = canvasRect.height - 30;
      
      return {
        x: Math.random() * maxX,
        y: Math.random() * maxY
      };
    }
    
    // åˆ›å»ºç›®æ ‡
    function createTarget() {
      // ç§»é™¤æ—§ç›®æ ‡
      const oldTarget = document.querySelector('.game-target');
      if (oldTarget) {
        oldTarget.remove();
      }
      
      // ç”Ÿæˆéšæœºä½ç½®
      const position = generateRandomPosition();
      gameState.targetX = position.x;
      gameState.targetY = position.y;
      
      // åˆ›å»ºæ–°ç›®æ ‡
      const target = document.createElement('div');
      target.className = 'game-target';
      target.style.left = `${position.x}px`;
      target.style.top = `${position.y}px`;
      
      gameElements.canvas.appendChild(target);
    }
    
    // æ£€æŸ¥ç¢°æ’
    function checkCollision() {
      const playerRect = gameElements.player.getBoundingClientRect();
      const target = document.querySelector('.game-target');
      
      if (!target) return false;
      
      const targetRect = target.getBoundingClientRect();
      
      return !(
        playerRect.right < targetRect.left ||
        playerRect.left > targetRect.right ||
        playerRect.bottom < targetRect.top ||
        playerRect.top > targetRect.bottom
      );
    }
    
    // ç§»åŠ¨ç©å®¶
    function movePlayer(x, y) {
      gameState.playerX = x;
      gameState.playerY = y;
      
      gameElements.player.style.left = `${x}px`;
      gameElements.player.style.top = `${y}px`;
      
      if (checkCollision()) {
        // æ”¶é›†ç›®æ ‡
        gameState.score += 1;
        gameElements.scoreDisplay.textContent = gameState.score;
        createTarget();
        
        // æ£€æŸ¥æˆå°±
        checkAchievements();
      }
    }
    
    // æ£€æŸ¥æˆå°±
    function checkAchievements() {
      // ç¤ºä¾‹ï¼šç¬¬ä¸€ä¸ªç‚¹
      if (gameState.score === 1) {
        unlockAchievement('first_point', 'ç¬¬ä¸€ç‚¹', 'æ”¶é›†äº†ä½ çš„ç¬¬ä¸€ä¸ªç‚¹');
      }
      
      // ç¤ºä¾‹ï¼šæ”¶é›†å¤§å¸ˆ
      if (gameState.score === 5) {
        unlockAchievement('collector_5', 'æ”¶é›†é«˜æ‰‹', 'æ”¶é›†äº†5ä¸ªç‚¹');
      }
      
      // ç¤ºä¾‹ï¼šæ”¶é›†è¾¾äºº
      if (gameState.score === 10) {
        unlockAchievement('collector_10', 'æ”¶é›†è¾¾äºº', 'æ”¶é›†äº†10ä¸ªç‚¹');
      }
    }
    
    // è§£é”æˆå°±
    function unlockAchievement(id, title, description) {
      // æ˜¾ç¤ºæˆå°±å¼¹çª—
      gameElements.achievementPopup.querySelector('.achievement-title').textContent = title;
      gameElements.achievementPopup.querySelector('.achievement-desc').textContent = description;
      gameElements.achievementPopup.classList.add('show');
      
      // 3ç§’åéšè—å¼¹çª—
      setTimeout(() => {
        gameElements.achievementPopup.classList.remove('show');
      }, 3000);
      
      // å‘é€æˆå°±åˆ°çˆ¶çª—å£
      sendAchievement(id, title, description);
    }
    
    // å‘çˆ¶çª—å£å‘é€æˆå°±
    function sendAchievement(id, title, description) {
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'GAME_ACHIEVEMENT',
          payload: {
            id,
            title,
            description,
            game: 'simple-collection-game',
            timestamp: new Date().toISOString()
          },
          source: 'game-iframe'
        }, '*');
      }
    }
    
    // å‘çˆ¶çª—å£å‘é€æ¸¸æˆè¿›åº¦
    function sendGameProgress() {
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'GAME_PROGRESS',
          payload: {
            score: gameState.score,
            level: Math.floor(gameState.score / 5) + 1,
            timestamp: new Date().toISOString()
          },
          source: 'game-iframe'
        }, '*');
      }
      
      alert(`è¿›åº¦å·²ä¿å­˜ï¼š${gameState.score}åˆ†`);
    }
    
    // å¤„ç†ä»çˆ¶çª—å£æ¥æ”¶çš„æ¶ˆæ¯
    function handleParentMessage(event) {
      // ç®€å•çš„å®‰å…¨æ£€æŸ¥ï¼ˆå®é™…ç¯å¢ƒä¸­åº”è¯¥æ›´ä¸¥æ ¼ï¼‰
      try {
        const data = event.data;
        
        if (!data || !data.type) return;
        
        switch (data.type) {
          case 'USER_INFO':
            handleUserInfo(data.payload);
            break;
            
          case 'GAME_CONTROL':
            handleGameControl(data.payload);
            break;
        }
      } catch (err) {
        console.error('å¤„ç†æ¶ˆæ¯å‡ºé”™:', err);
      }
    }
    
    // å¤„ç†ç”¨æˆ·ä¿¡æ¯
    function handleUserInfo(userInfo) {
      if (!userInfo) return;
      
      gameState.userInfo = userInfo;
      
      // æ›´æ–°UIæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
      if (userInfo.name) {
        gameElements.userName.textContent = userInfo.name;
      }
      
      if (userInfo.avatar) {
        // å¦‚æœæœ‰å¤´åƒURLï¼Œå¯ä»¥è®¾ç½®ä¸ºèƒŒæ™¯å›¾
        gameElements.userAvatar.innerHTML = '';
        gameElements.userAvatar.style.backgroundImage = `url(${userInfo.avatar})`;
        gameElements.userAvatar.style.backgroundSize = 'cover';
      } else if (userInfo.name) {
        // å¦åˆ™ä½¿ç”¨åå­—é¦–å­—æ¯
        gameElements.userAvatar.textContent = userInfo.name.charAt(0).toUpperCase();
      }
    }
    
    // å¤„ç†æ¸¸æˆæ§åˆ¶å‘½ä»¤
    function handleGameControl(controlData) {
      if (!controlData || !controlData.action) return;
      
      switch (controlData.action) {
        case 'pause':
          pauseGame();
          break;
          
        case 'resume':
          resumeGame();
          break;
          
        case 'restart':
          restartGame();
          break;
      }
    }
    
    // æš‚åœæ¸¸æˆ
    function pauseGame() {
      gameState.isPlaying = false;
      gameElements.startButton.textContent = 'ç»§ç»­æ¸¸æˆ';
    }
    
    // ç»§ç»­æ¸¸æˆ
    function resumeGame() {
      gameState.isPlaying = true;
      gameElements.startButton.textContent = 'æš‚åœæ¸¸æˆ';
    }
    
    // é‡æ–°å¼€å§‹æ¸¸æˆ
    function restartGame() {
      gameState.score = 0;
      gameElements.scoreDisplay.textContent = '0';
      gameState.isPlaying = true;
      gameElements.startButton.textContent = 'æš‚åœæ¸¸æˆ';
      createTarget();
    }
    
    // æ¸¸æˆåˆå§‹åŒ–
    function initGame() {
      // ç›‘å¬é¼ æ ‡ç§»åŠ¨
      gameElements.canvas.addEventListener('mousemove', function(e) {
        if (!gameState.isPlaying) return;
        
        const rect = gameElements.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        movePlayer(x, y);
      });
      
      // ç›‘å¬è§¦æ‘¸ç§»åŠ¨ï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
      gameElements.canvas.addEventListener('touchmove', function(e) {
        if (!gameState.isPlaying) return;
        
        e.preventDefault();
        const touch = e.touches[0];
        const rect = gameElements.canvas.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        
        movePlayer(x, y);
      });
      
      // å¼€å§‹/æš‚åœæŒ‰é’®
      gameElements.startButton.addEventListener('click', function() {
        if (gameState.isPlaying) {
          pauseGame();
        } else {
          resumeGame();
          // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å¼€å§‹ï¼Œåˆ›å»ºç›®æ ‡
          if (gameState.score === 0) {
            createTarget();
          }
        }
      });
      
      // ä¿å­˜è¿›åº¦æŒ‰é’®
      gameElements.saveProgressButton.addEventListener('click', sendGameProgress);
      
      // è§£é”æˆå°±æŒ‰é’®
      gameElements.achievementButton.addEventListener('click', function() {
        unlockAchievement(
          'manual_achievement',
          'æ‰‹åŠ¨æˆå°±',
          'ä½ æ‰‹åŠ¨è§£é”äº†ä¸€ä¸ªæˆå°±ï¼'
        );
      });
      
      // ç›‘å¬ä»çˆ¶çª—å£å‘æ¥çš„æ¶ˆæ¯
      window.addEventListener('message', handleParentMessage);
      
      // å‘ŠçŸ¥çˆ¶çª—å£æ¸¸æˆå·²åŠ è½½
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'GAME_LOADED',
          payload: {
            name: 'ç®€æ˜“æ”¶é›†æ¸¸æˆ',
            version: '1.0.0'
          },
          source: 'game-iframe'
        }, '*');
      }
    }
    
    // å¯åŠ¨æ¸¸æˆ
    document.addEventListener('DOMContentLoaded', initGame);
  </script>
</body>
</html> 